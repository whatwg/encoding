<!doctype html>
<html lang=en-US>
<meta charset=utf-8>
<title>Encoding Standard</title>
<style>
 @media print { [data-anolis-spec]::after { content:"[" attr(data-anolis-spec) "]"; font-size:.6em; vertical-align:super; text-transform:uppercase } }
</style>
<link rel=stylesheet href=http://www.whatwg.org/style/specification>
<link rel=icon href=http://www.whatwg.org/images/icon>

<div class=head>

<h1>Encoding</h1>
<h2 class="no-num no-toc">Living Standard &mdash; Last Updated [DATE: 01 Jan 1901]</h2>

<dl>
 <dt>This Version:
 <dd><a href=http://encoding.spec.whatwg.org/>http://encoding.spec.whatwg.org/</a>

 <dt>Participate:
 <dd>Send feedback to <a href="http://www.whatwg.org/mailing-list">whatwg@whatwg.org</a>
 (<a href="http://www.whatwg.org/mailing-list#specs">archives</a>) or
 <a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?product=WHATWG&amp;component=Encoding">file a bug</a>
 (<a href="https://www.w3.org/Bugs/Public/buglist.cgi?product=WHATWG&amp;component=Encoding&amp;resolution=---">open bugs</a>)
 <dd><a href="http://wiki.whatwg.org/wiki/IRC">IRC: #whatwg on Freenode</a>

 <dt>Version History:
 <dd><a href=https://github.com/whatwg/encoding/commits>https://github.com/whatwg/encoding/commits</a></dd>

 <dt>Editor:
 <dd class="vcard h-card">
  <a class="url u-url fn p-fn" lang="nl" href="http://annevankesteren.nl/">Anne van Kesteren</a>
  &lt;<a class="email u-email" href="mailto:annevk@annevk.nl">annevk@annevk.nl</a>>
</dl>

<script src=/hg/quirks-mode/raw-file/tip/file-bug.js async></script>

<p class=copyright><a rel="license" href="http://creativecommons.org/publicdomain/zero/1.0/">CC0 1.0 Universal</a>.
To the extent possible under law, the editor has waived all copyright and
related or neighboring rights to this work. In addition, as of
[DATE: 01 Jan 1901], the editor has made this specification available
under the
<a rel="license"
href="http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0">Open Web Foundation Agreement Version 1.0</a>,
which is available at
http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0.

</div>



<h2 class="no-num no-toc">Table of Contents</h2>

<!--toc-->


<h2>Preface</h2>

<p>While encodings for the web platform have been defined to some extent,
implementations have not always implemented them in the same way, have not
always used the same labels, and often differ in dealing with undefined and
former proprietary areas of encodings. This specification attempts to fill
those gaps so that new implementations do not have to reverse engineer
encoding implementations of the market leaders and existing implementations
can become more interoperable.

<p class=note>This specification is primarily intended for dealing with
legacy content, it requires new content and formats to use the
<span>utf-8</span> <span>encoding</span> exclusively.


<h2>Conformance</h2>

<p>All diagrams, examples, and notes in this specification are
non-normative, as are all sections explicitly marked non-normative.
Everything else in this specification is normative.

<p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
NOT",--> "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in the normative parts of this document are to be
interpreted as described in RFC2119. For readability, these words do
not appear in all uppercase letters in this specification.
<span data-anolis-ref>RFC2119</span>

<p>Conformance requirements phrased as algorithms or specific steps
may be implemented in any manner, so long as the end result is
equivalent. (In particular, the algorithms defined in this
specification are intended to be easy to follow, and not intended to
be performant.)

<p id="hardwareLimitations">User agents may impose
implementation-specific limits on otherwise unconstrained inputs,
e.g. to prevent denial of service attacks, to guard against running
out of memory, or to work around platform-specific limitations.


<h2>Terminology</h2>

<p>Hexadecimal numbers are prefixed with "0x".

<p>In equations, all numbers are integers, addition is represented by "+",
subtraction by "&minus;", multiplication by "&times;", division by "/",
calculating the remainder of a division (also known as modulo) by "%",
exponentiation by "<var title>b</var><sup><var title>n</var></sup>",
arithmetic left shifts by "&lt;&lt;", arithmetic right shifts by ">>",
bitwise AND by "&amp;", and bitwise OR by "|".

<p>A <dfn>byte</dfn> is referenced as a double-digit hexadecimal number in
the range 0x00 to 0xFF.

<p class=note>Web platform bytes consist of eight bits.

<p>A <dfn>code point</dfn> is a Unicode code point and is referenced as a
four-to-six digit hexadecimal number, typically prefixed with "U+".
In equations and <span title=index>indexes</span> it is prefixed with "0x".
<span data-anolis-ref>UNICODE</span>

<p>The <dfn>space characters</dfn>, for the purposes of this specification,
are U+0020 SPACE, U+0009 CHARACTER TABULATION (tab), U+000A LINE FEED (LF),
U+000C FORM FEED (FF), and U+000D CARRIAGE RETURN (CR).

<p>Comparing two strings in an <dfn>ASCII case-insensitive</dfn> manner
means comparing them exactly, code point for code point, except that the
characters in the range U+0041 to U+005A (i.e. LATIN CAPITAL LETTER A to
LATIN CAPITAL LETTER Z) and the corresponding characters in the range
U+0061 to U+007A (i.e. LATIN SMALL LETTER A to LATIN SMALL LETTER Z) are
considered to also match.


<h2>Encodings</h2>

<p>An <dfn>encoding</dfn> defines a mapping from a code point to one or more
bytes (and vice versa). Each <span>encoding</span> has a <dfn>name</dfn>,
and one or more <dfn title=label>labels</dfn>.

<p>Each <span>encoding</span> also has a <dfn>decoder</dfn> and
<dfn>encoder</dfn> algorithm.

<p>A <span>decoder</span> algorithm takes a stream of bytes and emits a
stream of code points. The <dfn>byte pointer</dfn> is initially zero,
pointing to the first byte in the stream. It cannot be negative. It can be
increased and decreased to point to other bytes in the stream. The
<dfn>EOF byte</dfn> is a conceptual byte representing the end of the
stream. The <span>byte pointer</span> cannot point beyond the
<span>EOF byte</span>. The <dfn>EOF code point</dfn> is a conceptual code
point that is emitted once the stream of bytes is handled in its entirety.
A <dfn>decoder error</dfn> indicates an error in the stream of bytes.
Unless stated otherwise emitting a <span>decoder error</span> must emit
code point U+FFFD.
A <span>decoder</span> can end by emitting a code point or
<span>decoder error</span>, or the word continue. Unless the
<span>EOF code point</span> is emitted, the
<span>decoder</span> algorithm must be invoked again.


<p class=note>An XML processor would halt upon the first
<span>decoder error</span> emitted.

<p>An <span>encoder</span> algorithm takes a
stream of code points and emits a stream of bytes. It will fail when
a code point is passed for which it does not have a corresponding byte or
byte sequence. Analogously to a <span>decoder</span>, it has a
<dfn>code point pointer</dfn> and <dfn>encoder error</dfn>.
Unless stated otherwise emitting an <span>encoder error</span> terminates
the <span>encoder</span>.
Again analogously, as long as the
<span>EOF byte</span> is not emitted, the <span>encoder</span> algorithm
must be invoked for each byte or sequence of bytes emitted.

<p class=note>HTML forms and URLs require non-terminating
<span title=encoder>encoders</span> and have therefore special handling
whenever an <span>encoder error</span> is reached. Instead of terminating
the <span>encoder</span> a sequence of one or more code points in the range
U+0000 to U+007F (representing the code point that caused the
<span>encoder error</span> to be emitted) are inserted into the stream of
code points at <span>code point pointer</span> after
<span>encoder error</span> is emitted.

<hr>

<p>The table below lists all <span title=encoding>encodings</span>
and their <span title=label>labels</span> user agents must support.
User agents must not support any other <span title=encoding>encodings</span>
or <span title=label>labels</span>.

<p>To <dfn title=concept-encoding-get>get an encoding</dfn> from a string
<var title>label</var>, run these steps:

<ol>
 <li><p>Remove any leading and trailing <span>space characters</span> from
 <var title>label</var>.

 <li><p>If <var title>label</var> is an <span>ASCII case-insensitive</span>
 match for any of the <span title=label>labels</span> listed in the table
 below, return the corresponding <span>encoding</span>, or return failure
 otherwise.
</ol>

<p class=note>This algorithm is different from the one defined
in
<a href="http://www.unicode.org/reports/tr22/tr22-7.html#Charset_Alias_Matching">section 1.4 of Unicode Technical Standard #22</a>
as that algorithm is incompatible with legacy content.

<table>
 <thead>
  <tr>
   <th><span>Name</span>
   <th><span title=label>Labels</span>
 <tbody>
  <tr><th colspan=2><a href=#the-encoding>The Encoding</a>
  <tr>
   <td rowspan=3><span>utf-8</span>
   <td>"<code title>unicode-1-1-utf-8</code>"
  <tr><td>"<code title>utf-8</code>"
  <tr><td>"<code title>utf8</code>"
 <tbody>
  <tr><th colspan=2><a href=#legacy-single-byte-encodings>Legacy single-byte encodings</a>
  <tr>
   <td rowspan=4><span>ibm866</span>
   <td>"<code title>866</code>"
  <tr><td>"<code title>cp866</code>"
  <tr><td>"<code title>csibm866</code>"
  <tr><td>"<code title>ibm866</code>"
  <tr>
   <td rowspan=9><span>iso-8859-2</span>
   <td>"<code title>csisolatin2</code>"
  <tr><td>"<code title>iso-8859-2</code>"
  <tr><td>"<code title>iso-ir-101</code>"
  <tr><td>"<code title>iso8859-2</code>"
  <tr><td>"<code title>iso88592</code>"
  <tr><td>"<code title>iso_8859-2</code>"
  <tr><td>"<code title>iso_8859-2:1987</code>"
  <tr><td>"<code title>l2</code>"
  <tr><td>"<code title>latin2</code>"
  <tr>
   <td rowspan=9><span>iso-8859-3</span>
   <td>"<code title>csisolatin3</code>"
  <tr><td>"<code title>iso-8859-3</code>"
  <tr><td>"<code title>iso-ir-109</code>"
  <tr><td>"<code title>iso8859-3</code>"
  <tr><td>"<code title>iso88593</code>"
  <tr><td>"<code title>iso_8859-3</code>"
  <tr><td>"<code title>iso_8859-3:1988</code>"
  <tr><td>"<code title>l3</code>"
  <tr><td>"<code title>latin3</code>"
  <tr>
   <td rowspan=9><span>iso-8859-4</span>
   <td>"<code title>csisolatin4</code>"
  <tr><td>"<code title>iso-8859-4</code>"
  <tr><td>"<code title>iso-ir-110</code>"
  <tr><td>"<code title>iso8859-4</code>"
  <tr><td>"<code title>iso88594</code>"
  <tr><td>"<code title>iso_8859-4</code>"
  <tr><td>"<code title>iso_8859-4:1988</code>"
  <tr><td>"<code title>l4</code>"
  <tr><td>"<code title>latin4</code>"
  <tr>
   <td rowspan=8><span>iso-8859-5</span>
   <td>"<code title>csisolatincyrillic</code>"
  <tr><td>"<code title>cyrillic</code>"
  <tr><td>"<code title>iso-8859-5</code>"
  <tr><td>"<code title>iso-ir-144</code>"
  <tr><td>"<code title>iso8859-5</code>"
  <tr><td>"<code title>iso88595</code>"
  <tr><td>"<code title>iso_8859-5</code>"
  <tr><td>"<code title>iso_8859-5:1988</code>"
  <tr>
   <td rowspan=14><span>iso-8859-6</span>
   <td>"<code title>arabic</code>"
  <tr><td>"<code title>asmo-708</code>"
  <tr><td>"<code title>csiso88596e</code>"
  <tr><td>"<code title>csiso88596i</code>"
  <tr><td>"<code title>csisolatinarabic</code>"
  <tr><td>"<code title>ecma-114</code>"
  <tr><td>"<code title>iso-8859-6</code>"
  <tr><td>"<code title>iso-8859-6-e</code>"
  <tr><td>"<code title>iso-8859-6-i</code>"
  <tr><td>"<code title>iso-ir-127</code>"
  <tr><td>"<code title>iso8859-6</code>"
  <tr><td>"<code title>iso88596</code>"
  <tr><td>"<code title>iso_8859-6</code>"
  <tr><td>"<code title>iso_8859-6:1987</code>"
  <tr>
   <td rowspan=12><span>iso-8859-7</span>
   <td>"<code title>csisolatingreek</code>"
  <tr><td>"<code title>ecma-118</code>"
  <tr><td>"<code title>elot_928</code>"
  <tr><td>"<code title>greek</code>"
  <tr><td>"<code title>greek8</code>"
  <tr><td>"<code title>iso-8859-7</code>"
  <tr><td>"<code title>iso-ir-126</code>"
  <tr><td>"<code title>iso8859-7</code>"
  <tr><td>"<code title>iso88597</code>"
  <tr><td>"<code title>iso_8859-7</code>"
  <tr><td>"<code title>iso_8859-7:1987</code>"
  <tr><td>"<code title>sun_eu_greek</code>"
  <tr>
   <td rowspan=14><span>iso-8859-8</span>
   <td>"<code title>csiso88598e</code>"
  <tr><td>"<code title>csiso88598i</code>"
  <tr><td>"<code title>csisolatinhebrew</code>"
  <tr><td>"<code title>hebrew</code>"
  <tr><td>"<code title>iso-8859-8</code>"
  <tr><td>"<code title>iso-8859-8-e</code>"
  <tr><td>"<code title>iso-8859-8-i</code>"
  <tr><td>"<code title>iso-ir-138</code>"
  <tr><td>"<code title>iso8859-8</code>"
  <tr><td>"<code title>iso88598</code>"
  <tr><td>"<code title>iso_8859-8</code>"
  <tr><td>"<code title>iso_8859-8:1988</code>"
  <tr><td>"<code title>logical</code>"
  <tr><td>"<code title>visual</code>"
  <tr>
   <td rowspan=7><span>iso-8859-10</span>
   <td>"<code title>csisolatin6</code>"
  <tr><td>"<code title>iso-8859-10</code>"
  <tr><td>"<code title>iso-ir-157</code>"
  <tr><td>"<code title>iso8859-10</code>"
  <tr><td>"<code title>iso885910</code>"
  <tr><td>"<code title>l6</code>"
  <tr><td>"<code title>latin6</code>"
  <tr>
   <td rowspan=3><span>iso-8859-13</span>
   <td>"<code title>iso-8859-13</code>"
  <tr><td>"<code title>iso8859-13</code>"
  <tr><td>"<code title>iso885913</code>"
  <tr>
   <td rowspan=3><span>iso-8859-14</span>
   <td>"<code title>iso-8859-14</code>"
  <tr><td>"<code title>iso8859-14</code>"
  <tr><td>"<code title>iso885914</code>"
  <tr>
   <td rowspan=6><span>iso-8859-15</span>
   <td>"<code title>csisolatin9</code>"
  <tr><td>"<code title>iso-8859-15</code>"
  <tr><td>"<code title>iso8859-15</code>"
  <tr><td>"<code title>iso885915</code>"
  <tr><td>"<code title>iso_8859-15</code>"
  <tr><td>"<code title>l9</code>"
  <tr>
   <td><span>iso-8859-16</span>
   <td>"<code title>iso-8859-16</code>"
  <tr>
   <td rowspan=5><span>koi8-r</span>
   <td>"<code title>cskoi8r</code>"
  <tr><td>"<code title>koi</code>"
  <tr><td>"<code title>koi8</code>"
  <tr><td>"<code title>koi8-r</code>"
  <tr><td>"<code title>koi8_r</code>"
  <tr>
   <td><span>koi8-u</span>
   <td>"<code title>koi8-u</code>"
  <tr>
   <td rowspan=4><span>macintosh</span>
   <td>"<code title>csmacintosh</code>"
  <tr><td>"<code title>mac</code>"
  <tr><td>"<code title>macintosh</code>"
  <tr><td>"<code title>x-mac-roman</code>"
  <tr>
   <td rowspan=6><span>windows-874</span>
   <td>"<code title>dos-874</code>"
  <tr><td>"<code title>iso-8859-11</code>"
  <tr><td>"<code title>iso8859-11</code>"
  <tr><td>"<code title>iso885911</code>"
  <tr><td>"<code title>tis-620</code>"
  <tr><td>"<code title>windows-874</code>"
  <tr>
   <td rowspan=3><span>windows-1250</span>
   <td>"<code title>cp1250</code>"
  <tr><td>"<code title>windows-1250</code>"
  <tr><td>"<code title>x-cp1250</code>"
  <tr>
   <td rowspan=3><span>windows-1251</span>
   <td>"<code title>cp1251</code>"
  <tr><td>"<code title>windows-1251</code>"
  <tr><td>"<code title>x-cp1251</code>"
  <tr>
   <td rowspan=17><span>windows-1252</span>
   <td>"<code title>ansi_x3.4-1968</code>"
  <tr><td>"<code title>ascii</code>"
  <tr><td>"<code title>cp1252</code>"
  <tr><td>"<code title>cp819</code>"
  <tr><td>"<code title>csisolatin1</code>"
  <tr><td>"<code title>ibm819</code>"
  <tr><td>"<code title>iso-8859-1</code>"
  <tr><td>"<code title>iso-ir-100</code>"
  <tr><td>"<code title>iso8859-1</code>"
  <tr><td>"<code title>iso88591</code>"
  <tr><td>"<code title>iso_8859-1</code>"
  <tr><td>"<code title>iso_8859-1:1987</code>"
  <tr><td>"<code title>l1</code>"
  <tr><td>"<code title>latin1</code>"
  <tr><td>"<code title>us-ascii</code>"
  <tr><td>"<code title>windows-1252</code>"
  <tr><td>"<code title>x-cp1252</code>"
  <tr>
   <td rowspan=3><span>windows-1253</span>
   <td>"<code title>cp1253</code>"
  <tr><td>"<code title>windows-1253</code>"
  <tr><td>"<code title>x-cp1253</code>"
  <tr>
   <td rowspan=12><span>windows-1254</span>
   <td>"<code title>cp1254</code>"
  <tr><td>"<code title>csisolatin5</code>"
  <tr><td>"<code title>iso-8859-9</code>"
  <tr><td>"<code title>iso-ir-148</code>"
  <tr><td>"<code title>iso8859-9</code>"
  <tr><td>"<code title>iso88599</code>"
  <tr><td>"<code title>iso_8859-9</code>"
  <tr><td>"<code title>iso_8859-9:1989</code>"
  <tr><td>"<code title>l5</code>"
  <tr><td>"<code title>latin5</code>"
  <tr><td>"<code title>windows-1254</code>"
  <tr><td>"<code title>x-cp1254</code>"
  <tr>
   <td rowspan=3><span>windows-1255</span>
   <td>"<code title>cp1255</code>"
  <tr><td>"<code title>windows-1255</code>"
  <tr><td>"<code title>x-cp1255</code>"
  <tr>
   <td rowspan=3><span>windows-1256</span>
   <td>"<code title>cp1256</code>"
  <tr><td>"<code title>windows-1256</code>"
  <tr><td>"<code title>x-cp1256</code>"
  <tr>
   <td rowspan=3><span>windows-1257</span>
   <td>"<code title>cp1257</code>"
  <tr><td>"<code title>windows-1257</code>"
  <tr><td>"<code title>x-cp1257</code>"
  <tr>
   <td rowspan=3><span>windows-1258</span>
   <td>"<code title>cp1258</code>"
  <tr><td>"<code title>windows-1258</code>"
  <tr><td>"<code title>x-cp1258</code>"
  <tr>
   <td rowspan=2><span>x-mac-cyrillic</span>
   <td>"<code title>x-mac-cyrillic</code>"
  <tr><td>"<code title>x-mac-ukrainian</code>"
 <tbody>
  <tr><th colspan=2><a href=#legacy-multi-byte-chinese-(simplified)-encodings>Legacy multi-byte Chinese (simplified) encodings</a>
  <tr>
   <td rowspan=9><span>gbk</span>
   <td>"<code title>chinese</code>"
  <tr><td>"<code title>csgb2312</code>"
  <tr><td>"<code title>csiso58gb231280</code>"
  <tr><td>"<code title>gb2312</code>"
  <tr><td>"<code title>gb_2312</code>"
  <tr><td>"<code title>gb_2312-80</code>"
  <tr><td>"<code title>gbk</code>"
  <tr><td>"<code title>iso-ir-58</code>"
  <tr><td>"<code title>x-gbk</code>"
  <tr>
   <td><span>gb18030</span>
   <td>"<code title>gb18030</code>"
  <tr>
   <td><span>hz-gb-2312</span>
   <td>"<code title>hz-gb-2312</code>"
 <tbody>
  <tr><th colspan=2><a href=#legacy-multi-byte-chinese-(traditional)-encodings>Legacy multi-byte Chinese (traditional) encodings</a>
  <tr>
   <td rowspan=5><span>big5</span>
   <td>"<code title>big5</code>"
  <tr><td>"<code title>big5-hkscs</code>"
  <tr><td>"<code title>cn-big5</code>"
  <tr><td>"<code title>csbig5</code>"
  <tr><td>"<code title>x-x-big5</code>"
 <tbody>
  <tr><th colspan=2><a href=#legacy-multi-byte-japanese-encodings>Legacy multi-byte Japanese encodings</a>
  <tr>
   <td rowspan=3><span>euc-jp</span>
   <td>"<code title>cseucpkdfmtjapanese</code>"
  <tr><td>"<code title>euc-jp</code>"
  <tr><td>"<code title>x-euc-jp</code>"
  <tr>
   <td rowspan=2><span>iso-2022-jp</span>
   <td>"<code title>csiso2022jp</code>"
  <tr><td>"<code title>iso-2022-jp</code>"
  <tr>
   <td rowspan=7><span>shift_jis</span>
   <td>"<code title>csshiftjis</code>"
  <tr><td>"<code title>ms_kanji</code>"
  <tr><td>"<code title>shift-jis</code>"
  <tr><td>"<code title>shift_jis</code>"
  <tr><td>"<code title>sjis</code>"
  <tr><td>"<code title>windows-31j</code>"
  <tr><td>"<code title>x-sjis</code>"
 <tbody>
  <tr><th colspan=2><a href=#legacy-multi-byte-korean-encodings>Legacy multi-byte Korean encodings</a>
  <tr>
   <td rowspan=10><span>euc-kr</span>
   <td>"<code title>cseuckr</code>"
  <tr><td>"<code title>csksc56011987</code>"
  <tr><td>"<code title>euc-kr</code>"
  <tr><td>"<code title>iso-ir-149</code>"
  <tr><td>"<code title>korean</code>"
  <tr><td>"<code title>ks_c_5601-1987</code>"
  <tr><td>"<code title>ks_c_5601-1989</code>"
  <tr><td>"<code title>ksc5601</code>"
  <tr><td>"<code title>ksc_5601</code>"
  <tr><td>"<code title>windows-949</code>"
  <tr>
   <td rowspan=2><span>iso-2022-kr</span>
   <td>"<code title>csiso2022kr</code>"
  <tr><td>"<code title>iso-2022-kr</code>"
 <tbody>
  <tr><th colspan=2><a href=#legacy-utf-16-encodings>Legacy utf-16 encodings</a>
  <tr>
   <td rowspan=2><span>utf-16</span>
   <td>"<code title>utf-16</code>"
  <tr><td>"<code title>utf-16le</code>"
  <tr>
   <td><span>utf-16be</span>
   <td>"<code title>utf-16be</code>"
</table>

<p class=note>All <span title=encoding>encodings</span> and their
<span title=label>labels</span> are also available as non-normative
<a href=encodings.json>encodings.json</a> resource.



<h2>Indexes</h2>

<p>Most legacy <span title=encoding>encodings</span> make use of
an <dfn>index</dfn>. An <span>index</span> is an ordered list of
pointers and corresponding code points. Within an <span>index</span>
pointers are unique and code points can be duplicated.

<p>To find the pointers and their corresponding code points in an <span>index</span>,
let <var title>lines</var> be the result of splitting the resource's contents on U+000A.
Then remove each item in <var title>lines</var> that is the empty string or starts with U+0023.
Then the pointers and their corresponding code points are found by splitting each item in <var title>lines</var> on U+0009.
The first subitem is the pointer (as a decimal number) and the second is the corresponding code point (as a hexadecimal number).
Other subitems are not relevant.

<p>The <dfn>index code point</dfn> for <var title>pointer</var> in
<var title>index</var> is the code point corresponding to
<var title>pointer</var> in <var title>index</var>, or null if
<var title>pointer</var> is not in <var title>index</var>.

<p>The <dfn>index pointer</dfn> for <var title>code point</var> in
<var title>index</var> is the <em>first</em> pointer corresponding to
<var title>code point</var> in <var title>index</var>, or null if
<var title>code point</var> is not in <var title>index</var>.

<p>These are the <span title=index>indexes</span> defined by this
specification, excluding <span>index single-byte</span>:

<table>
 <tr><th colspan=2><span>Index</span><th>Notes
 <tr>
  <td><dfn>index big5</dfn>
  <td><a href=index-big5.txt>index-big5.txt</a>
  <td>This matches the Big5 standard in combination with the
  Hong Kong Supplementary Character Set and other common extensions.
 <tr>
  <td><dfn>index euc-kr</dfn>
  <td><a href=index-euc-kr.txt>index-euc-kr.txt</a>
  <td>This matches the KS X 1001 standard and the Unified Hangul Code, more
  commonly known together as Windows Codepage 949.
 <tr>
  <td><dfn>index gbk</dfn>
  <td><a href=index-gbk.txt>index-gbk.txt</a>
  <td>This matches the GB18030 standard for code points encoded as two
  bytes.
 <tr>
  <td><dfn>index gb18030</dfn>
  <td><a href=index-gb18030.txt>index-gb18030.txt</a>
  <td>This <span>index</span> works different from all others. Listing all
  code points would result in over a million items whereas they can be
  represented neatly in 207 ranges combined with trivial limit checks. It
  therefore only superficially matches the GB18030 standard for code points
  encoded as four bytes. See also <span>index gb18030 code point</span> and
  <span>index gb18030 pointer</span> below.
 <tr>
  <td><dfn>index jis0208</dfn>
  <td><a href=index-jis0208.txt>index-jis0208.txt</a>
  <td>This is the JIS X 0208 standard including formerly proprietary
  extensions from IBM and NEC.
  <!-- NEC = Nippon Electronics Corporation -->
 <tr>
  <td><dfn>index jis0212</dfn>
  <td><a href=index-jis0212.txt>index-jis0212.txt</a>
  <td>This is the JIS X 0212 standard.
</table>

<p>The <dfn>index gb18030 code point</dfn> for <var title>pointer</var> is
the return value of these steps:

<ol>
 <li><p>If <var title>pointer</var> is greater than 39419 and less than
 189000, or <var title>pointer</var> is greater than 1237575, return null.

 <li><p>Let <var title>offset</var> be the last pointer in
 <span>index gb18030</span> that is equal to or less than
 <var title>pointer</var> and let <var title>code point offset</var> be its
 corresponding code point.

 <li><p>Return a code point whose value is
 <var title>code point offset</var> + <var title>pointer</var> &minus; <var title>offset</var>.
</ol>

<p>The <dfn>index gb18030 pointer</dfn> for <var title>code point</var> is
the return value of these steps:

<ol>
 <li><p>Let <var title>offset</var> be the last code point in
 <span>index gb18030</span> that is equal to or less than
 <var title>code point</var> and let <var title>pointer offset</var> be its
 corresponding pointer.

 <li><p>Return a pointer whose value is
 <var title>pointer offset</var> + <var title>code point</var> &minus; <var title>offset</var>.
</ol>


<p class=note>All <span title=index>indexes</span> are also available as
non-normative <a href=indexes.json>indexes.json</a> resource.
(<span>index gb18030</span> has a slightly different format here, to be able
to represent ranges.)



<h2>Decode and encode</h2>

<p class=note>The algorithms <span>decode</span>, <span>utf-8 decode</span>,
and <span>encode</span> are intended for usage by other specifications.
<span>utf-8 decode</span> is to be used by new formats. The
<span title=concept-encoding-get>get an encoding</span> algorithm can be
used first to turn a <span>label</span> into an <span>encoding</span>.

<p>To <dfn>decode</dfn> a byte stream <var title>stream</var> using
fallback encoding <var title>encoding</var>, run these steps:

<ol>
 <li><p>Let <var title>offset</var> be 0.

 <li>
  <p>For each of the rows in the following table, starting with the first
  one and going down, if the first bytes of <var title>stream</var> match
  all the bytes given in the first column (ergo <var title>stream</var>
  contains at least two or three bytes), then set <var title>encoding</var>
  to the <span>encoding</span> given in the cell in the second column of
  that row, and set <var title>offset</var> to the offset given in the cell
  in the third column of that row.

  <table>
   <tr><th>Byte order mark<th>Encoding<th>Offset
   <tr><td>0xFF 0xFE<td><span>utf-16</span><td>2
   <tr><td>0xFE 0xFF<td><span>utf-16be</span><td>2
   <tr><td>0xEF 0xBB 0xBF<td><span>utf-8</span><td>3
  </table>

  <p class=note>For compatibility with deployed content, the byte order mark
  (also known as BOM) is considered more authoritative than anything else.

 <li><p>Return the result of running <var title>encoding</var>'s
 <span>decoder</span> with <span>byte pointer</span> set to
 <var title>offset</var>, on <var title>stream</var>.
</ol>

<p>To <dfn>utf-8 decode</dfn> a byte stream <var title>stream</var>, run
these steps:

<ol>
 <li><p>Let <var title>offset</var> be 0.

 <li><p>If <var title>stream</var> contains at least three bytes and its
 first three bytes match 0xEF 0xBB 0xBF, set <var title>offset</var> to 3.

 <li><p>Return the result of running the <span>utf-8 decoder</span> with
 <span>byte pointer</span> set to <var title>offset</var>, on
 <var title>stream</var>.
</ol>

<p>To <dfn>encode</dfn> a code point stream <var title>stream</var> using
encoding <var title>encoding</var>, return the result of running
<var title>encoding</var>'s <span>encoder</span> on <var title>stream</var>.


<h2>The encoding</h2>

<p>New content and formats must exclusively use the <span>utf-8</span>
<span>encoding</span>.


<h3><dfn>utf-8</dfn></h3>

<!--
http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#utf-8
Unicode
-->

<p>The <dfn>utf-8 code point</dfn>, <dfn>utf-8 bytes seen</dfn>,
<dfn>utf-8 bytes needed</dfn>, and <dfn>utf-8 lower boundary</dfn> concepts
are all initially 0.

<p>The <dfn>utf-8 decoder</dfn> (<span>decoder</span> for <span>utf-8</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>utf-8 bytes needed</span> is not 0, set
 <span>utf-8 bytes needed</span> to 0 and emit a <span>decoder error</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span>, emit the
 <span>EOF code point</span>.

 <li><p>Increase the <span>byte pointer</span>.

 <li>
  <p>If <span>utf-8 bytes needed</span> is 0, based on
  <var title>byte</var>:

  <dl class=switch>
   <dt>0x00 to 0x7F
   <dd><p>Emit a code point whose value is <var title>byte</var>.

   <dt>0xC2 to 0xDF
   <dd><p>Set <span>utf-8 bytes needed</span> to 1,
   <span>utf-8 lower boundary</span> to 0x80, and
   <span>utf-8 code point</span> to <var title>byte</var> &minus; 0xC0.

   <dt>0xE0 to 0xEF
   <dd><p>Set <span>utf-8 bytes needed</span> to 2,
   <span>utf-8 lower boundary</span> to 0x800, and
   <span>utf-8 code point</span> to <var title>byte</var> &minus; 0xE0.

   <dt>0xF0 to 0xF4
   <dd><p>Set <span>utf-8 bytes needed</span> to 3,
   <span>utf-8 lower boundary</span> to 0x10000, and
   <span>utf-8 code point</span> to <var title>byte</var> &minus; 0xF0.

   <dt>Otherwise
   <dd><p>Emit a <span>decoder error</span>.
  </dl>

  <p>Then (<var title>byte</var> is in the range 0xC2 to 0xF4) set
  <span>utf-8 code point</span> to <span>utf-8 code point</span> &times;
  64<sup><span>utf-8 bytes needed</span></sup> and continue.

 <li>
  <p>If <var title>byte</var> is not in the range 0x80 to 0xBF, run these
  substeps:

  <ol>
   <li><p>Set <span>utf-8 code point</span>,
   <span>utf-8 bytes needed</span>, <span>utf-8 bytes seen</span>, and
   <span>utf-8 lower boundary</span> to 0.

   <li><p>Decrease the <span>byte pointer</span> by one.

   <li><p>Emit a <span>decoder error</span>.
  </ol>

 <li>
  <p>Increase <span>utf-8 bytes seen</span> by one and set
  <span>utf-8 code point</span> to
  <span>utf-8 code point</span> + (<var title>byte</var> &minus; 0x80) &times;
  64<sup><span>utf-8 bytes needed</span> &minus; <span>utf-8 bytes seen</span></sup>

 <li><p>If <span>utf-8 bytes seen</span> is not equal to
 <span>utf-8 bytes needed</span>, continue.

 <li><p>Let <var title>code point</var> be <span>utf-8 code point</span> and
 <var title>lower boundary</var> be <span>utf-8 lower boundary</span>.

 <li><p>Set <span>utf-8 code point</span>,
 <span>utf-8 bytes needed</span>, <span>utf-8 bytes seen</span>, and
 <span>utf-8 lower boundary</span> to 0.

 <li><p>If <var title>code point</var> is in the range
 <var title>lower boundary</var> to 0x10FFFF and is not
 in the range 0xD800 to 0xDFFF, emit a code point whose value is
 <var title>code point</var>.

 <li><p>Emit a <span>decoder error</span>.
</ol>


<p>The <dfn>utf-8 encoder</dfn> (<span>encoder</span> for <span>utf-8</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is in the range 0xD800 to 0xDFFF,
 emit an <span>encoder error</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <li>
  <p>Set <var title>count</var> and <var title>offset</var> based on the
  range <var title>code point</var> is in:

  <dl class=switch>
   <dt>U+0080 to U+07FF
   <dd>1 and 0xC0
   <dt>U+0800 to U+FFFF
   <dd>2 and 0xE0
   <dt>U+10000 to U+10FFFF
   <dd>3 and 0xF0
  </dl>

 <li><p>Let <var title>bytes</var> be a list of bytes whose first byte is
 <var title>code point</var> / 64<sup><var title>count</var></sup> + <var title>offset</var>.

 <li>
  <p>Run these substeps while <var title>count</var> is greater than 0:

  <ol>
   <li><p>Set <var title>temp</var> to
   <var title>code point</var> / 64<sup><var title>count</var> &minus; 1</sup>.
   <!--temp = code_point >> ((count - 1) * 6)-->

   <li><p>Append to <var title>bytes</var>
   0x80 + (<var title>temp</var> % 64).
   <!--0x80 | (temp & 0x3f)-->

   <li><p>Decrease <var title>count</var> by one.
  </ol>

 <li><p>Emit bytes <var title>bytes</var>, in list order.
</ol>


<h2>Legacy single-byte encodings</h2>

<p>An <span>encoding</span> where each byte is either a single code point or
nothing, is a <dfn>single-byte encoding</dfn>.
All <span title="single-byte encoding">single-byte encodings</span> use the
same <span>decoder</span> and <span>encoder</span>, but use a different
<span>index</span>. <dfn>Index single-byte</dfn>, as referenced by the
<span>single-byte decoder</span> and <span>single-byte encoder</span>, is
defined by the following table, and depends on the
<span>single-byte encoding</span> in use.

<table>
 <tr><th><span>Name</name><th><span>Index</span>
 <tr><td><dfn>ibm866</dfn><td><a href=index-ibm866.txt>index-ibm866.txt</a>
 <tr><td><dfn>iso-8859-2</dfn><td><a href=index-iso-8859-2.txt>index-iso-8859-2.txt</a>
 <tr><td><dfn>iso-8859-3</dfn><td><a href=index-iso-8859-3.txt>index-iso-8859-3.txt</a>
 <tr><td><dfn>iso-8859-4</dfn><td><a href=index-iso-8859-4.txt>index-iso-8859-4.txt</a>
 <tr><td><dfn>iso-8859-5</dfn><td><a href=index-iso-8859-5.txt>index-iso-8859-5.txt</a>
 <tr><td><dfn>iso-8859-6</dfn><td><a href=index-iso-8859-6.txt>index-iso-8859-6.txt</a>
 <tr><td><dfn>iso-8859-7</dfn><td><a href=index-iso-8859-7.txt>index-iso-8859-7.txt</a>
 <tr><td><dfn>iso-8859-8</dfn><td><a href=index-iso-8859-8.txt>index-iso-8859-8.txt</a>
 <tr><td><dfn>iso-8859-10</dfn><td><a href=index-iso-8859-10.txt>index-iso-8859-10.txt</a>
 <tr><td><dfn>iso-8859-13</dfn><td><a href=index-iso-8859-13.txt>index-iso-8859-13.txt</a>
 <tr><td><dfn>iso-8859-14</dfn><td><a href=index-iso-8859-14.txt>index-iso-8859-14.txt</a>
 <tr><td><dfn>iso-8859-15</dfn><td><a href=index-iso-8859-15.txt>index-iso-8859-15.txt</a>
 <tr><td><dfn>iso-8859-16</dfn><td><a href=index-iso-8859-16.txt>index-iso-8859-16.txt</a>
 <tr><td><dfn>koi8-r</dfn><td><a href=index-koi8-r.txt>index-koi8-r.txt</a>
 <tr><td><dfn>koi8-u</dfn><td><a href=index-koi8-u.txt>index-koi8-u.txt</a>
 <tr><td><dfn>macintosh</dfn><td><a href=index-macintosh.txt>index-macintosh.txt</a>
 <tr><td><dfn>windows-874</dfn><td><a href=index-windows-874.txt>index-windows-874.txt</a>
 <tr><td><dfn>windows-1250</dfn><td><a href=index-windows-1250.txt>index-windows-1250.txt</a>
 <tr><td><dfn>windows-1251</dfn><td><a href=index-windows-1251.txt>index-windows-1251.txt</a>
 <tr><td><dfn>windows-1252</dfn><td><a href=index-windows-1252.txt>index-windows-1252.txt</a>
 <tr><td><dfn>windows-1253</dfn><td><a href=index-windows-1253.txt>index-windows-1253.txt</a>
 <tr><td><dfn>windows-1254</dfn><td><a href=index-windows-1254.txt>index-windows-1254.txt</a>
 <tr><td><dfn>windows-1255</dfn><td><a href=index-windows-1255.txt>index-windows-1255.txt</a>
 <tr><td><dfn>windows-1256</dfn><td><a href=index-windows-1256.txt>index-windows-1256.txt</a>
 <tr><td><dfn>windows-1257</dfn><td><a href=index-windows-1257.txt>index-windows-1257.txt</a>
 <tr><td><dfn>windows-1258</dfn><td><a href=index-windows-1258.txt>index-windows-1258.txt</a>
 <tr><td><dfn>x-mac-cyrillic</dfn><td><a href=index-x-mac-cyrillic.txt>index-x-mac-cyrillic.txt</a>
</table>

<hr>

<p>The <dfn>single-byte decoder</dfn> (<span>decoder</span> for
<span title="single-byte encoding">single-byte encodings</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span>, emit the
 <span>EOF code point</span>.

 <li><p>Increase the <span>byte pointer</span> by one.

 <li><p>If <var title>byte</var> is in the range 0x00 to 0x7F, emit a code
 point whose value is <var title>byte</var>.

 <li><p>Let <var title>code point</var> be the <span>index code point</span>
 for <var title>byte</var> &minus; 0x80 in <span>index single-byte</span>.

 <li><p>If <var title>code point</var> is null, emit a
 <span>decoder error</span>.

 <li><p>Emit a code point whose value is <var title>code point</var>.
</ol>

<p>The <dfn>single-byte encoder</dfn> (<span>encoder</span> for
<span title="single-byte encoding">single-byte encodings</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index single-byte</span>.

 <li><p>If <var title>pointer</var> is null, emit an
 <span>encoder error</span>.

 <li><p>Emit a byte whose value is <var title>pointer</var> + 0x80.
</ol>



<h2>Legacy multi-byte Chinese (simplified) encodings</h2>


<h3><dfn>gbk</dfn></h3>

<p>The <dfn>gb18030 flag</dfn> flag is initially unset. It can only be set
by the <span>gb18030 decoder</span> and <span>gb18030 encoder</span>.

<p>The <dfn>gbk first</dfn>, <dfn>gbk second</dfn>, and
<dfn>gbk third</dfn>, are all initially 0x00.

<p>The <dfn>gbk decoder</dfn> (<span>decoder</span> for <span>gbk</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>gbk first</span>, <span>gbk second</span>, and <span>gbk third</span>
 are 0x00, emit the <span>EOF code point</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span>, and
 <span>gbk first</span>, <span>gbk second</span>, or <span>gbk third</span>
 is not 0x00, set <span>gbk first</span>, <span>gbk second</span>, and
 <span>gbk third</span> to 0x00, and emit a <span>decoder error</span>.

 <li><p>Increase the <span>byte pointer</span>.

 <li>
  <p>If <span>gbk third</span> is not 0x00, run these substeps:

  <ol>
   <li><p>Let <var title>code point</var> be null.

   <li><p>If <var title>byte</var> is in the range 0x30 to 0x39, set
   <var title>code point</var> to the
   <span>index gb18030 code point</span> for
   (((<span>gbk first</span> &minus; 0x81) &times; 10 + <span>gbk second</span> &minus; 0x30) &times; 126 + <span>gbk third</span> &minus; 0x81) &times; 10 + <var title>byte</var> &minus; 0x30.

   <li><p>Set <span>gbk first</span>, <span>gbk second</span>, and
   <span>gbk third</span> to 0x00.

   <li><p>If <var title>code point</var> is null, decrease the
   <span>byte pointer</span> by three and emit a <span>decoder error</span>.

   <li><p>Emit a code point whose value is <var title>code point</var>.
  </ol>

 <li>
  <p>If <span>gbk second</span> is not 0x00, run these substeps:

  <ol>
   <li><p>If <var title>byte</var> is in the range 0x81 to 0xFE, set
   <span>gbk third</span> to <var title>byte</var> and continue.

   <li><p>Decrease the <span>byte pointer</span> by two, set
   <span>gbk first</span> and <span>gbk second</span> to 0x00, and emit a
   <span>decoder error</span>.
  </ol>

 <li>
  <p>If <span>gbk first</span> is not 0x00, run these substeps:

  <ol>
   <li><p>If <var title>byte</var> is in the range 0x30 to 0x39 and the
   <span>gb18030 flag</span> is set, set <span>gbk second</span> to
   <var title>byte</var> and continue.

   <li><p>Let <var title>lead</var> be <span>gbk first</span>, let
   <var title>pointer</var> be null, and set <span>gbk first</span> to 0x00.

   <li><p>Let <var title>offset</var> be 0x40 if <var title>byte</var> is
   less than 0x7F, or 0x41 otherwise.

   <li><p>If <var title>byte</var> is in the range 0x40 to 0x7E or
   0x80 to 0xFE, set <var title>pointer</var> to
   (<var title>lead</var> &minus; 0x81) &times; 190 + (<var title>byte</var> &minus; <var title>offset</var>).

   <li><p>Let <var title>code point</var> be null if
   <var title>pointer</var> is null, or the <span>index code point</span>
   for <var title>pointer</var> in <span>index gbk</span> otherwise.

   <li><p>If <var title>pointer</var> is null, decrease the
   <span>byte pointer</span> by one.

   <li><p>If <var title>code point</var> is null, emit a
   <span>decoder error</span>.

   <li><p>Emit a code point whose value is <var title>code point</var>.
  </ol>

 <li><p>If <var title>byte</var> is in the range 0x00 to 0x7F, emit a code
 point whose value is <var title>byte</var>.

 <li><p>If <var title>byte</var> is 0x80, emit code point U+20AC.

 <li><p>If <var title>byte</var> is in the range 0x81 to 0xFE, set
 <span>gbk first</span> to <var title>byte</var> and continue.

 <li><p>Emit a <span>decoder error</span>.
</ol>

<p>The <dfn>gbk encoder</dfn> (<span>encoder</span> for <span>gbk</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <!-- also present in index gbk
 <li><p>If <var title>code point</var> is U+20AC, emit byte 0x80.
 -->

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index gbk</span>.

 <li>
  <p>If <var title>pointer</var> is not null, run these substeps:

  <ol>
   <li><p>Let <var title>lead</var> be
   <var title>pointer</var> / 190 + 0x81.

   <li><p>Let <var title>trail</var> be <var title>pointer</var> % 190.

   <li><p>Let <var title>offset</var> be 0x40 if <var title>trail</var> is
   less than 0x3F,<!--0x7F-0x40--> or 0x41 otherwise.

   <li><p>Emit two bytes whose values are <var title>lead</var> and
   <var title>trail</var> + <var title>offset</var>.
  </ol>

 <li><p>If <var title>pointer</var> is null and the
 <span>gb18030 flag</span> is unset, emit an <span>encoder error</span>.

 <li><p>Set <var title>pointer</var> to the
 <span>index gb18030 pointer</span> for <var title>code point</var>.

 <li><p>Let <var title>byte1</var> be
 <var title>pointer</var> / 10 / 126 / 10.

 <li><p>Set <var title>pointer</var> to
 <var title>pointer</var> &minus; <var title>byte1</var> &times; 10 &times; 126 &times; 10.

 <li><p>Let <var title>byte2</var> be
 <var title>pointer</var> / 10 / 126.

 <li><p>Set <var title>pointer</var> to
 <var title>pointer</var> &minus; <var title>byte2</var> &times; 10 &times; 126.

 <li><p>Let <var title>byte3</var> be
 <var title>pointer</var> / 10.

 <li><p>Let <var title>byte4</var> be
 <var title>pointer</var> &minus; <var title>byte3</var> &times; 10.

 <li><p>Emit four bytes whose values are <var title>byte1</var> + 0x81,
 <var title>byte2</var> + 0x30, <var title>byte3</var> + 0x81,
 <var title>byte4</var> + 0x30.
</ol>


<h3><dfn>gb18030</dfn></h3>

<p>The <dfn>gb18030 decoder</dfn> (<span>decoder</span> for <span>gb18030</span>) is
the <span>gbk decoder</span> with the <span>gb18030 flag</span> set.

<p>The <dfn>gb18030 encoder</dfn> (<span>encoder</span> for <span>gb18030</span>) is
the <span>gbk encoder</span> with the <span>gb18030 flag</span> set.


<h3><dfn>hz-gb-2312</dfn></h3>
<!--
 http://tools.ietf.org/html/rfc1842
 http://tools.ietf.org/html/rfc1843
-->

<p>The <dfn>hz-gb-2312 flag</dfn> is initially unset. The
<dfn>hz-gb-2312 lead</dfn> is initially 0x00.</p>

<p>The <dfn>hz-gb-2312 decoder</dfn> (<span>decoder</span> for <span>hz-gb-2312</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>hz-gb-2312 lead</span> is 0x00, emit the
 <span>EOF code point</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>hz-gb-2312 lead</span> is not 0x00, set <span>hz-gb-2312 lead</span>
 to 0x00 and emit a <span>decoder error</span>.

 <li><p>Increase the <span>byte pointer</span>.

 <li>
  <p>If <span>hz-gb-2312 lead</span> is 0x7E, set
  <span>hz-gb-2312 lead</span> to 0x00, and based on <var title>byte</var>:

  <dl class=switch>
   <dt>0x7B<!--{-->
   <dd><p>Set the <span>hz-gb-2312 flag</span> and continue.

   <dt>0x7D<!--}-->
   <dd><p>Unset the <span>hz-gb-2312 flag</span> and continue.
   <!--In "ASCII mode" IE outputs ~}, Gecko outputs U+FFFD, Chrome outputs
   a single U+FFFD for ~}~}. Weird. Opera just skips.-->

   <dt>0x7E<!--~-->
   <dd><p>Emit code point U+007E.

   <dt>0x0A<!--newline-->
   <dd><p>Continue.

   <dt>Otherwise
   <dd><p>Decrease the <span>byte pointer</span> by one and emit a
   <span>decoder error</span>.
  </dl>

 <li>
  <p>If <span>hz-gb-2312 lead</span> is not 0x00, let
  <var title>lead</var> be <span>hz-gb-2312 lead</span>, set
  <span>hz-gb-2312 lead</span> to 0x00, and then run these substeps:

  <ol>
   <li><p>If <var title>byte</var> is in the range 0x21 to 0x7E, let
   <var title>code point</var> be the <span>index code point</span> for
   (<var title>lead</var> &minus; 1) &times; 190 + (<var title>byte</var> + 0x3F)
   in <span>index gbk</span>.
   <!--lead-1    = lead+0x80-0x81
       byte+0x3F = byte+0x80-0x41-->

   <li><p>If <var title>byte</var> is 0x0A, unset the
   <span>hz-gb-2312 flag</span>.

   <li><p>If <var title>code point</var> is null, emit a
   <span>decoder error</span>.

   <li><p>Emit a code point whose value is <var title>code point</var>.
  </ol>

 <li><p>If <var title>byte</var> is 0x7E<!--~-->, set
 <span>hz-gb-2312 lead</span> to 0x7E and continue.

 <li>
  <p>If the <span>hz-gb-2312 flag</span> is set:

  <ol>
   <li><p>If <var title>byte</var> is in the range 0x20 to 0x7F, set
   <span>hz-gb-2312 lead</span> to <var title>byte</var> and continue.

   <li><p>If <var title>byte</var> is 0x0A, unset the
   <span>hz-gb-2312 flag</span>.

   <li><p>Emit a <span>decoder error</span>.
  </ol>

 <li><p>If <var title>byte</var> is in the range 0x00 to 0x7F, emit a
 code point whose value is <var title>byte</var>.

 <li><p>Emit a <span>decoder error</span>.
</ol>

<p>The <dfn>hz-gb-2312 encoder</dfn> (<span>encoder</span> for <span>hz-gb-2312</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F and
 the <span>hz-gb-2312 flag</span> is set, decrease the
 <span>code point pointer</span> by one, unset the
 <span>hz-gb-2312 flag</span>, and emit two bytes 0x7E 0x7D.

 <li><p>If <var title>code point</var> is 0x007E, emit two bytes 0x7E 0x7E.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <li><p>If the <span>hz-gb-2312 flag</span> is unset, decrease the
 <span>code point pointer</span> by one, set the
 <span>hz-gb-2312 flag</span>, and emit two bytes 0x7E 0x7B.

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index gbk</span>.

 <li><p>If <var title>pointer</var> is null, emit an
 <span>encoder error</span>.

 <li><p>Let <var title>lead</var> be <var title>pointer</var> / 190 + 1.

 <li><p>Let <var title>trail</var> be <var title>pointer</var> % 190 &minus; 0x3F.

 <li><p>If either <var title>lead</var> or <var>trail</var> is not in the
 range 0x21 to 0x7E, emit an <span>encoder error</span>.

 <li><p>Emit two bytes whose values are <var title>lead</var> and
 <var title>trail</var>.
</ol>



<h2>Legacy multi-byte Chinese (traditional) encodings</h2>

<!--
 Lead:  0x81 to 0xFE
 Trail: 0x40 to 0x7E or 0xA1 to 0xFE
-->


<h3><dfn>big5</dfn></h3>

<p>The <dfn>big5 lead</dfn> is initially 0x00.

<p>The <dfn>big5 decoder</dfn> (<span>decoder</span> for <span>big5</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>big5 lead</span> is 0x00, emit the
 <span>EOF code point</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>big5 lead</span> is not 0x00, set <span>big5 lead</span> to 0x00 and
 emit a <span>decoder error</span>.

 <li><p>Increase the <span>byte pointer</span> by one.

 <li>
  <p>If <span>big5 lead</span> is not 0x00, let <var title>lead</var> be
  <span>big5 lead</span>, let <var title>pointer</var> be null, set
  <span>big5 lead</span> to 0x00, and then run these substeps:

  <ol>
   <li><p>Let <var title>offset</var> be 0x40 if <var title>byte</var> is
   less than 0x7F, or 0x62 otherwise.
   <!-- 0x62 = 0xA1-0x7E+1+0x40 -->

   <li><p>If <var title>byte</var> is in the range 0x40 to 0x7E or
   0xA1 to 0xFE, set <var title>pointer</var> to
   (<var title>lead</var> &minus; 0x81) &times; 157 + (<var title>byte</var> &minus; <var title>offset</var>).

   <li>
    <p>If there is a row in the table below whose first column is
    <var title>pointer</var>, emit the <em>two</em> code points listed in
    its second column:

    <table>
     <tr><th>Pointer<th>Code points
     <tr><td>1133<!-- 0x88 0x62 --><td>U+00CA U+0304<!-- Ê̄ -->
     <tr><td>1135<!-- 0x88 0x64 --><td>U+00CA U+030C<!-- Ê̌ -->
     <tr><td>1164<!-- 0x88 0xA3 --><td>U+00EA U+0304<!-- ê̄ -->
     <tr><td>1166<!-- 0x88 0xA5 --><td>U+00EA U+030C<!-- ê̌ -->
    </table>
    <!-- we do this to avoid PUA -->

    <p class=note>Since <span title=index>indexes</span> are limited to
    single code points this table is used for these pointers.

   <li><p>Let <var title>code point</var> be null if
   <var title>pointer</var> is null, or the <span>index code point</span>
   for <var title>pointer</var> in <span>index big5</span> otherwise.

   <li><p>If <var title>pointer</var> is null, decrease the
   <span>byte pointer</span> by one.

   <li><p>If <var title>code point</var> is null, emit a
   <span>decoder error</span>.

   <li><p>Emit a code point whose value is <var title>code point</var>.
  </ol>

 <li><p>If <var title>byte</var> is in the range 0x00 to 0x7F, emit a code
 point whose value is <var title>byte</var>.

 <li><p>If <var title>byte</var> is in the range 0x81 to 0xFE, set
 <span>big5 lead</span> to <var title>byte</var> and continue.

 <li><p>Emit a <span>decoder error</span>.
</ol>

<p>The <dfn>big5 encoder</dfn> (<span>encoder</span> for <span>big5</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index big5</span>.

 <li><p>If <var title>pointer</var> is null, emit an
 <span>encoder error</span>.

 <li><p>Let <var title>lead</var> be <var title>pointer</var> / 157 + 0x81.

 <li>
  <p>If <var title>lead</var> is less than 0xA1, emit an
  <span>encoder error</span>.

  <p class=note>Avoid emitting Hong Kong Supplementary Character Set
  extensions literally.

 <li><p>Let <var title>trail</var> be <var title>pointer</var> % 157.

 <li><p>Let <var title>offset</var> be 0x40 if <var title>trail</var> is
   less than 0x3F,<!--0x7F-0x40--> or 0x62<!--0xA1-0x3F--> otherwise.

 <li><p>Emit two bytes whose values are <var title>lead</var> and
 <var title>trail</var> + <var title>offset</var>.
</ol>



<h2>Legacy multi-byte Japanese encodings</h2>


<h3><dfn>euc-jp</dfn></h3>

<!-- http://www.iana.org/assignments/charset-reg/CP51932 -->

<p>The <dfn>euc-jp first</dfn> and <dfn>euc-jp second</dfn> are 0x00.

<p>The <dfn>euc-jp decoder</dfn> (<span>decoder</span> for <span>euc-jp</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>euc-jp first</span> and <span>euc-jp second</span> are 0x00, emit the
 <span>EOF code point</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and either
 <span>euc-jp first</span> or <span>euc-jp second</span> is not 0x00, set
 <span>euc-jp first</span> and <span>euc-jp second</span> to 0x00, and emit
 a <span>decoder error</span>.

 <li><p>Increase the <span>byte pointer</span> by one.

 <li>
  <p>If <span>euc-jp second</span> is not 0x00, let <var title>lead</var> be
  <span>euc-jp second</span>, set <span>euc-jp second</span> to 0x00 and run
  these substeps:

  <ol>
   <li><p>Let <var title>code point</var> be null.

   <li><p>If <var title>lead</var> and <var title>byte</var> are both in the
   range 0xA1 to 0xFE, set <var title>code point</var> to the
   <span>index code point</span> for
   (<var title>lead</var> &minus; 0xA1) &times; 94 + <var title>byte</var> &minus; 0xA1
   in <span>index jis0212</span>.

   <li><p>If <var title>byte</var> is not in the range 0xA1 to 0xFE,
   decrease <span>byte pointer</span> by one.

   <li><p>If <var title>code point</var> is null, emit a
   <span>decoder error</span>.

   <li><p>Emit a code point whose value is <var title>code point</var>.
  </ol>

 <li><p>If <span>euc-jp first</span> is 0x8E and <var title>byte</var> is
 in the range 0xA1 to 0xDF, set <span>euc-jp first</span> to 0x00 and emit
 a code point whose value is 0xFF61 + <var title>byte</var> &minus; 0xA1.
 <!-- katakana -->

 <li><p>If <span>euc-jp first</span> is 0x8F and <var title>byte</var> is
 in the range 0xA1 to 0xFE, set <span>euc-jp first</span> to 0x00,
 <span>euc-jp second</span> to <var title>byte</var>, and continue.

 <li><p>If <span>euc-jp first</span> is not 0x00, let <var title>lead</var>
 be <span>euc-jp first</span>, set <span>euc-jp first</span> to 0x00, and
 run these substeps:

  <ol>
   <li><p>Let <var title>code point</var> be null.

   <li><p>If <var title>lead</var> and <var title>byte</var> are both in the
   range 0xA1 to 0xFE, set <var title>code point</var> to the
   <span>index code point</span> for
   (<var title>lead</var> &minus; 0xA1) &times; 94 + <var title>byte</var> &minus; 0xA1
   in <span>index jis0208</span>.

   <li><p>If <var title>byte</var> is not in the range 0xA1 to 0xFE,
   decrease <span>byte pointer</span> by one.

   <li><p>If <var title>code point</var> is null, emit a
   <span>decoder error</span>.

   <li><p>Emit a code point whose value is <var title>code point</var>.
  </ol>

 <li><p>If <var title>byte</var> is in the range 0x00 to 0x7F, emit a
 code point whose value is <var title>byte</var>.

 <li><p>If <var title>byte</var> is 0x8E, 0x8F, or in the range 0xA1 to
 0xFE, set <span>euc-jp first</span> to <var title>byte</var> and continue.

 <li><p>Emit a <span>decoder error</span>.
</ol>

<p>The <dfn>euc-jp encoder</dfn> (<span>encoder</span> for <span>euc-jp</span>) is:

<!--
 No JIX X 0212 encoder support:
   https://bugzilla.mozilla.org/show_bug.cgi?id=600715
   http://code.google.com/p/chromium/issues/detail?id=78847
-->

<ol>
 <li><p>Let <var title>code point</var> be the
 <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <li><p>If <var title>code point</var> is U+00A5, emit byte 0x5C.

 <li><p>If <var title>code point</var> is U+203E, emit byte 0x7E.

 <li><p>If <var title>code point</var> is in the range U+FF61 to U+FF9F,
 emit two bytes whose values are 0x8E and
 <var title>code point</var> &minus; 0xFF61 + 0xA1.

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index jis0208</span>.

 <li><p>If <var title>pointer</var> is null, emit an
 <span>encoder error</span>.

 <li><p>Let <var title>lead</var> be <var title>pointer</var> / 94 + 0xA1.

 <li><p>Let <var title>trail</var> be <var title>pointer</var> % 94 + 0xA1.

 <li><p>Emit two bytes whose values are <var title>lead</var> and
 <var title>trail</var>.
</ol>

<p class=note>Contemporary implementations do not use
<span>index jis0212</span> for the <span>euc-jp encoder</span>.


<h3><dfn>iso-2022-jp</dfn></h3>
<!--
 http://tools.ietf.org/html/rfc1468
 http://tools.ietf.org/html/rfc2237 (iso-2022-jp-1)
-->

<p>The <dfn>iso-2022-jp state</dfn> is initially <b title>ASCII state</b>.

<p>The <dfn>iso-2022-jp jis0212 flag</dfn> is initially unset.

<p>The <dfn>iso-2022-jp lead</dfn> is initially 0x00.

<p>The <dfn>iso-2022-jp decoder</dfn> (<span>decoder</span> for <span>iso-2022-jp</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is not the <span>EOF byte</span>,
 increase the <span>byte pointer</span> by one.

 <li>
  <p>Based on <span>iso-2022-jp state</span>:

  <dl class=switch>
   <dt>ASCII state

   <dd>
    <p>Based on <var title>byte</var>:

    <dl class=switch>
     <dt>0x1B
     <dd><p>Set <span>iso-2022-jp state</span> to
     <b title>escape start state</b> and continue.

     <dt>0x00 to 0x7F
     <dd><p>Emit a code point whose value is <var title>byte</var>.

     <dt><span>EOF byte</span>
     <dd><p>Emit the <span>EOF code point</span>.

     <dt>Otherwise
     <dd><p>Emit a <span>decoder error</span>.
    </dl>

   <dt>Escape start state
   <dd>
    <ol>
     <li><p>If <var title>byte</var> is either <!--$-->0x24 or
     <!--(-->0x28, set <span>iso-2022-jp lead</span> to
     <var title>byte</var>, <span>iso-2022-jp state</span> to
     <b title>escape middle state</b>, and continue.

     <li><p>If <var title>byte</var> is not the <span>EOF byte</span>,
     decrease the <span>byte pointer</span> by one.

     <li><p>Set <span>iso-2022-jp state</span> to <b title>ASCII state</b>
     and emit a <span>decoder error</span>.
    </ol>

   <dt>Escape middle state
   <dd>
    <ol>
     <li><p>Let <var title>lead</var> be <span>iso-2022-jp lead</span> and
     set <span>iso-2022-jp lead</span> to 0x00.

     <li><p>If <var title>lead</var> is 0x24 and <var title>byte</var> is
     either 0x40<!--@--> or 0x42<!--B-->, unset the
     <span>iso-2022-jp jis0212 flag</span>, set
     <span>iso-2022-jp state</span> to <b title>lead state</b>, and
     continue.

     <li><p>If <var title>lead</var> is 0x24 and <var title>byte</var> is
     0x28, set <span>iso-2022-jp state</span> to
     <b title>escape final state</b> and continue.

     <li><p>If <var title>lead</var> is 0x28 and <var title>byte</var> is
     either 0x42<!--B--> or 0x4A<!--J-->, set <span>iso-2022-jp state</span>
     to <b title>ASCII state</b> and continue.

     <li><p>If <var title>lead</var> is 0x28 and <var title>byte</var> is
     0x49<!--I-->, set <span>iso-2022-jp state</span> to
     <b title>Katakana state</b> and continue.

     <li><p>If <var title>byte</var> is the <span>EOF byte</span>,
     decrease <span>byte pointer</span> by one, or decrease it by two
     otherwise.

     <li><p>Set <span>iso-2022-jp state</span> to <b title>ASCII state</b>
     and emit a <span>decoder error</span>.
    </ol>

   <dt>Escape final state
   <dd>
    <ol>
     <li><p>If <var title>byte</var> is 0x44<!--D-->, set the
     <span>iso-2022-jp jis0212 flag</span>, set
     <span>iso-2022-jp state</span> to <b title>lead state</b>, and
     continue.

     <li><p>If <var title>byte</var> is the <span>EOF byte</span>,
     decrease <span>byte pointer</span> by two, or decrease it by three
     otherwise.

     <li><p>Set <span>iso-2022-jp state</span> to <b title>ASCII state</b>
     and emit a <span>decoder error</span>.
    </ol>

   <dt>Lead state
   <dd>
    <p>Based on <var title>byte</var>:
    <dl class=switch>
     <dt>0x0A
     <dd><p>Set <span>iso-2022-jp state</span> to <b title>ASCII state</b>
     and emit code point U+000A.

     <dt>0x1B
     <dd><p>Set <span>iso-2022-jp state</span> to
     <b title>escape start state</b> and continue.

     <dt><span>EOF byte</span>
     <dd><p>Emit the <span>EOF code point</span>.

     <dt>Otherwise
     <dd><p>Set <span>iso-2022-jp lead</span> to <var title>byte</var>,
     <span>iso-2022-jp state</span> to <b title>trail state</b>, and
     continue.
    </dl>

   <dt>Trail state
   <dd>
    <ol>
     <li><p>Set the <span>iso-2022-jp state</span> to
     <b title>lead state</b>.

     <li><p>If <var title>byte</var> is the <span>EOF byte</span>, emit a
     <span>decoder error</span>.

     <li><p>Let <var title>code point</var> be null and let
     <var title>pointer</var> be
     (<span>iso-2022-jp lead</span> &minus; 0x21) &times; 94 + <var title>byte</var> &minus; 0x21.

     <li><p>If <span>iso-2022-jp lead</span> and <var title>byte</var> are
     both in the range 0x21 to 0x7E, set <var title>code point</var> to
     the <span>index code point</span> for <var title>pointer</var> in
     <span>index jis0208</span> if the <span>iso-2022-jp jis0212 flag</span>
     is unset, or in <span>index jis0212</span> otherwise.

     <li><p>If <var title>code point</var> is null, emit a
     <span>decoder error</span>.

     <li><p>Emit a code point whose value is <var title>code point</var>.
    </ol>

   <dt>Katakana state
   <dd>
    <p>Based on <var title>byte</var>:
    <dl class=switch>
     <dt>0x1B
     <dd><p>Set <span>iso-2022-jp state</span> to
     <b title>escape start state</b> and continue.

     <dt>0x21 to 0x5F
     <dd><p>Emit a code point whose value is
     0xFF61 + <var title>byte</var> &minus; 0x21.
     <!-- katakana -->

     <dt><span>EOF byte</span>
     <dd><p>Emit the <span>EOF code point</span>.

     <dt>Otherwise
     <dd><p>Emit a <span>decoder error</span>.
    </dl>
  </dl>
</ol>

<p>The <dfn>iso-2022-jp encoder</dfn> (<span>encoder</span> for <span>iso-2022-jp</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F, or
 is U+00A5 or U+203E, and <span>iso-2022-jp state</span> is not
 <b title>ASCII state</b>, decrease the <span>code point pointer</span> by
 one, set <span>iso-2022-jp state</span> to <b title>ASCII state</b>, and
 emit three bytes 0x1B 0x28 0x42.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <li><p>If <var title>code point</var> is U+00A5, emit byte 0x5C.

 <li><p>If <var title>code point</var> is U+203E, emit byte 0x7E.

 <li><p>If <var title>code point</var> is in the range U+FF61 to U+FF9F and
 <span>iso-2022-jp state</span> is not <b title>Katakana state</b>, decrease
 the <span>code point pointer</span> by one, set
 <span>iso-2022-jp state</span> to <b title>Katakana state</b>, and emit
 three bytes 0x1B 0x28 0x49.

 <li><p>If <var title>code point</var> is in the range U+FF61 to U+FF9F,
 emit a byte whose value is
 <var title>code point</var> &minus; 0xFF61 + 0x21.

 <li><p>If <span>iso-2022-jp state</span> is not <b title>lead state</b>,
 decrease the <span>code point pointer</span> by one, set
 <span>iso-2022-jp state</span> to <b title>lead state</b>, and emit three
 bytes 0x1B 0x24 0x42.

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index jis0208</span>.

 <li><p>If <var title>pointer</var> is null, emit an
 <span>encoder error</span>.

 <li><p>Let <var title>lead</var> be <var title>pointer</var> / 94 + 0x21.

 <li><p>Let <var title>trail</var> be <var title>pointer</var> % 94 + 0x21.

 <li><p>Emit two bytes whose values are <var title>lead</var> and
 <var title>trail</var>.
</ol>


<h3><dfn>shift_jis</dfn></h3>

<p>The <dfn>shift_jis lead</dfn> is initially 0x00.

<p>The <dfn>shift_jis decoder</dfn> (<span>decoder</span> for <span>shift_jis</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>shift_jis lead</span> is 0x00, emit the
 <span>EOF code point</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span>,
 <span>shift_jis lead</span> is not 0x00, set <span>shift_jis lead</span> to
 0x00 and emit a <span>decoder error</span>.

 <li><p>Increase the <span>byte pointer</span> by one.

 <li>
  <p>If <span>shift_jis lead</span> is not 0x00, let <var title>lead</var>
  be <span>shift_jis lead</span>, let <var title>pointer</var> be null, set
  <span>shift_jis lead</span> to 0x00, and then run these substeps:

  <ol>
   <li><p>Let <var title>offset</var> be 0x40 if <var title>byte</var> is
   less than 0x7F, or 0x41 otherwise.

   <li><p>Let <var title>lead offset</var> be 0x81 if <var title>lead</var>
   is less than 0xA0, or 0xC1 otherwise.

   <li><p>If <var title>byte</var> is in the range 0x40 to 0x7E or
   0x80 to 0xFC, set <var title>pointer</var> to
   (<var title>lead</var> &minus; <var title>lead offset</var>) &times; 188 + <var title>byte</var> &minus; <var title>offset</var>.

   <li><p>Let <var title>code point</var> be null if
   <var title>pointer</var> is null, or the <span>index code point</span>
   for <var title>pointer</var> in <span>index jis0208</span> otherwise.

   <li><p>If <var title>pointer</var> is null, decrease the
   <span>byte pointer</span> by one.

   <li><p>If <var title>code point</var> is null, emit a
   <span>decoder error</span>.

   <li><p>Emit a code point whose value is <var title>code point</var>.
  </ol>

 <li><p>If <var title>byte</var> is in the range 0x00 to 0x80, emit a
 code point whose value is <var title>byte</var>.
 <!-- Opera has 0x7E -->

 <li><p>If <var title>byte</var> is in the range 0xA1 to 0xDF, emit a
 code point whose value is 0xFF61 + <var title>byte</var> &minus; 0xA1.
 <!-- katakana -->

 <li><p>If <var title>byte</var> is in the range 0x81 to 0x9F or
 0xE0 to 0xFC, set <span>shift_jis lead</span> to <var title>byte</var> and
 continue.

 <li><p>Emit a <span>decoder error</span>.
</ol>

<p>The <dfn>shift_jis encoder</dfn> (<span>encoder</span> for <span>shift_jis</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be the
 <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+0080,
 emit a byte whose value is <var title>code point</var>.

 <li><p>If <var title>code point</var> is U+00A5, emit byte 0x5C.

 <li><p>If <var title>code point</var> is U+203E, emit byte 0x7E.

 <li><p>If <var title>code point</var> is in the range U+FF61 to U+FF9F,
 emit a byte whose value is
 <var title>code point</var> &minus; 0xFF61 + 0xA1.

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index jis0208</span>.

 <li><p>If <var title>pointer</var> is null, emit an
 <span>encoder error</span>.

 <li><p>Let <var title>lead</var> be <var title>pointer</var> / 188.

 <li><p>Let <var title>lead offset</var> be 0x81 if <var title>lead</var> is
 less than 0x1F, or 0xC1 otherwise.
 <!-- 0xA0-0x81 -->

 <li><p>Let <var title>trail</var> be <var title>pointer</var> % 188.

 <li><p>Let <var title>offset</var> be 0x40 if <var title>trail</var> is
 less than 0x3F, or 0x41 otherwise.

 <li><p>Emit two bytes whose values are
 <var title>lead</var> + <var title>lead offset</var> and
 <var title>trail</var> + <var title>offset</var>.
</ol>


<h2>Legacy multi-byte Korean encodings</h2>


<h3><dfn>euc-kr</dfn></h3>

<p>The <dfn>euc-kr lead</dfn> is initially 0x00.

<p>The <dfn>euc-kr decoder</dfn> (<span>decoder</span> for <span>euc-kr</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>euc-kr lead</span> is 0x00, emit the
 <span>EOF code point</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>euc-kr lead</span> is not 0x00, set <span>euc-kr lead</span> to 0x00
 and emit a <span>decoder error</span>.

 <li><p>Increase the <span>byte pointer</span> by one.

 <li>
  <p>If <span>euc-kr lead</span> is not 0x00, let <var title>lead</var> be
  <span>euc-kr lead</span>, let <var title>pointer</var> be null,
  set <span>euc-kr lead</span> to 0x00, and then run these substeps:

  <ol>
   <li>
    <p>If <var title>lead</var> is in the range 0x81 to 0xC6, let
    <var title>temp</var> be
    (26 + 26 + 126) &times; (<var title>lead</var> &minus; 0x81), and then
    set <var title>pointer</var> to the result of the equation below,
    depending on <var title>byte</var>:

    <dl class=switch>
     <dt>0x41 to 0x5A
     <dd><p><var title>temp</var> + <var title>byte</var> &minus; 0x41
     <dt>0x61 to 0x7A
     <dd><p><var title>temp</var> + 26 + <var title>byte</var> &minus; 0x61
     <dt>0x81 to 0xFE
     <dd><p><var title>temp</var> + 26 + 26 + <var title>byte</var> &minus; 0x81
    </dl>

   <li><p>If <var title>lead</var> is in the range 0xC7 to 0xFE and
   <var title>byte</var> is in the range 0xA1 to 0xFE, set
   <var title>pointer</var> to
   (26 + 26 + 126) &times; (0xC7 &minus; 0x81) + (<var title>lead</var> &minus; 0xC7) &times; 94 + (<var title>byte</var> &minus; 0xA1).

   <li><p>Let <var title>code point</var> be null if
   <var title>pointer</var> is null, or the
   <span>index code point</span> for <var title>pointer</var> in
   <span>index euc-kr</span> otherwise.

   <li><p>If <var title>pointer</var> is null, decrease the
   <span>byte pointer</span> by one.

   <li><p>If <var title>code point</var> is null, emit a
   <span>decoder error</span>.

   <li><p>Emit a code point whose value is <var title>code point</var>.
  </ol>

 <li><p>If <var title>byte</var> is in the range 0x00 to 0x7F, emit a
 code point whose value is <var title>byte</var>.

 <li><p>If <var title>byte</var> is in the range 0x81 to 0xFE, set
 <span>euc-kr lead</span> to <var title>byte</var> and continue.

 <li><p>Emit a <span>decoder error</span>.
</ol>

<p>The <dfn>euc-kr encoder</dfn> (<span>encoder</span> for <span>euc-kr</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be the
 <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index euc-kr</span>.

 <li><p>If <var title>pointer</var> is null, emit an
 <span>encoder error</span>.

 <li>
  <p>If <var title>pointer</var> is less than
  (26 + 26 + 126) &times; (0xC7 &minus; 0x81), run these substeps:

  <ol>
   <li><p>Let <var title>lead</var> be
   <var title>pointer</var> / (26 + 26 + 126) + 0x81.

   <li><p>Let <var title>trail</var> be
   <var title>pointer</var> % (26 + 26 + 126).

   <li><p>Let <var title>offset</var> be 0x41 if <var title>trail</var> is
   less than 26, 0x47 if <var title>trail</var> is less than 26 + 26, or
   0x4D otherwise.
   <!-- 0x47=0x41+0x61-0x5A-1
        0x4D=0x47+0x81-0x7A-1 -->

   <li><p>Emit two bytes whose values are <var title>lead</var> and
   <var title>trail</var> + <var title>offset</var>.
  </ol>

 <li><p>Set <var title>pointer</var> to
 <var title>pointer</var> &minus; (26 + 26 + 126) × (0xC7 − 0x81).

 <li><p>Let <var title>lead</var> be <var title>pointer</var> / 94 + 0xC7.

 <li><p>Let <var title>trail</var> be <var title>pointer</var> % 94 + 0xA1.

 <li><p>Emit two bytes whose values are <var title>lead</var> and
 <var title>trail</var>.
</ol>


<h3><dfn>iso-2022-kr</dfn></h3>

<!--XXX the "ESC $ ) C" sequence is only supported by Gecko at the start of
a stream. It does exactly nothing. Trying to get away with not supporting it
at all.-->

<p>The <dfn>iso-2022-kr state</dfn> is initially <b title>ASCII state</b>.

<p>The <dfn>iso-2022-kr lead</dfn> is initially 0x00.

<p>The <dfn>iso-2022-kr decoder</dfn> (<span>decoder</span> for <span>iso-2022-kr</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is not the <span>EOF byte</span>,
 increase the <span>byte pointer</span> by one.

 <li>
  <p>Based on <span>iso-2022-kr state</span>:

  <dl class=switch>
   <dt>ASCII state

   <dd>
    <p>Based on <var title>byte</var>:

    <dl class=switch>
     <dt>0x0E
     <dd><p>Set <span>iso-2022-kr state</span> to <b title>lead state</b>
     and continue.

     <dt>0x0F
     <dd><p>Continue.

     <dt>0x1B
     <dd><p>Set <span>iso-2022-kr state</span> to
     <b title>escape start state</b> and continue.

     <dt>0x00 to 0x7F
     <dd><p>Emit a code point whose value is <var title>byte</var>.

     <dt><span>EOF byte</span>
     <dd><p>Emit the <span>EOF code point</span>.

     <dt>Otherwise
     <dd><p>Emit a <span>decoder error</span>.
    </dl>

   <dt>Escape start state<!-- 0x24 = $ -->
   <dd>
    <ol>
     <li><p>If <var title>byte</var> is 0x24, set
     <span>iso-2022-kr state</span> to <b title>escape middle state</b> and
     continue.

     <li><p>If <var title>byte</var> is not the <span>EOF byte</span>,
     decrease the <span>byte pointer</span> by one.

     <li><p>Set <span>iso-2022-kr state</span> to <b title>ASCII state</b>
     and emit a <span>decoder error</span>.
    </ol>

   <dt>Escape middle state<!-- 0x29 = ) -->
   <dd>
    <ol>
     <li><p>If <var title>byte</var> is 0x29, set
     <span>iso-2022-kr state</span> to <b title>escape end state</b> and
     continue.

     <li><p>If <var title>byte</var> is the <span>EOF byte</span>, decrease
     the <span>byte pointer</span> by one, or decrease it by two otherwise.

     <li><p>Set <span>iso-2022-kr state</span> to <b title>ASCII state</b>
     and emit a <span>decoder error</span>.
    </ol>

   <dt>Escape end state<!-- 0x43 = C -->
   <dd>
    <ol>
     <li><p>If <var title>byte</var> is 0x43, set
     <span>iso-2022-kr state</span> to <b title>ASCII state</b> and
     continue.

     <li><p>If <var title>byte</var> is the <span>EOF byte</span>, decrease
     the <span>byte pointer</span> by two, or decrease it by three
     otherwise.

     <li><p>Set <span>iso-2022-kr state</span> to <b title>ASCII state</b>
     and emit a <span>decoder error</span>.
    </ol>

   <dt>Lead state
   <dd>
    <p>Based on <var title>byte</var>:
    <dl class=switch>
     <dt>0x0A
     <dd><p>Set <span>iso-2022-kr state</span> to <b title>ASCII state</b>
     and emit code point U+000A.

     <dt>0x0E
     <dd><p>Continue.

     <dt>0x0F
     <dd><p>Set <span>iso-2022-kr state</span> to <b title>ASCII state</b>
     and continue.

     <dt><span>EOF byte</span>
     <dd><p>Emit the <span>EOF code point</span>.

     <dt>Otherwise
     <dd><p>Set <span>iso-2022-kr lead</span> to <var title>byte</var>, set
     <span>iso-2022-kr state</span> to <b title>trail state</b>, and
     continue.
    </dl>

   <dt>Trail state
   <dd>
    <ol>
     <li><p>Set the <span>iso-2022-kr state</span> to
     <b title>lead state</b>.

     <li><p>If <var title>byte</var> is the <span>EOF byte</span>, emit a
     <span>decoder error</span>.

     <li><p>Let <var title>code point</var> be null.

     <li><p>If <span>iso-2022-kr lead</span> is in the range 0x21 to 0x46
     and <var title>byte</var> is in the range 0x21 to 0x7E, set
     <var title>code point</var> to the <span>index code point</span> for
     (26 + 26 + 126) &times; (<span>iso-2022-kr lead</span> &minus; 1) + 26 + 26 + <var title>byte</var> &minus; 1
     in <span>index euc-kr</span>.

     <li><p>If <span>iso-2022-kr lead</span> is in the range 0x47 to 0x7E
     and <var title>byte</var> is in the range 0x21 to 0x7E, set
     <var title>code point</var> to the <span>index code point</span> for
     (26 + 26 + 126) &times; (0xC7 &minus; 0x81) + (<span>iso-2022-kr lead</span> &minus; 0x47) &times; 94 + (<var title>byte</var> &minus; 0x21)
     in <span>index euc-kr</span>.

     <li><p>If <var title>code point</var> is not null, emit
     <var title>code point</var>.

     <li><p>Emit a <span>decoder error</span>.
    </ol>
  </dl>
</ol>

<p>The <dfn>iso-2022-kr initialization flag</dfn> is initially unset.</p>

<p>The <dfn>iso-2022-kr encoder</dfn> (<span>encoder</span> for <span>iso-2022-kr</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>
 and <span>iso-2022-kr state</span> is not <b title>ASCII state</b>, set
 <span>iso-2022-kr state</span> to <b title>ASCII state</b> and emit byte
 0x0F.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>If the <span>iso-2022-kr initialization flag</span> is unset, set
 the <span>iso-2022-kr initialization flag</span> and emit four bytes
 0x1B 0x24 0x29 0x43.
 <!-- ESC $ ) C -->

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F and
 <span>iso-2022-kr state</span> is not <b title>ASCII state</b>, decrease
 the <span>code point pointer</span> by one, set
 <span>iso-2022-kr state</span> to <b title>ASCII state</b>, and emit byte
 0x0F.

 <li><p>If <var title>code point</var> is in the range U+0000 to U+007F,
 emit a byte whose value is <var title>code point</var>.

 <li><p>If <span>iso-2022-kr state</span> is not <b title>lead state</b>,
 decrease the <span>code point pointer</span> by one, set
 <span>iso-2022-kr state</span> to <b title>lead state</b>, and emit byte
 0x0E.

 <li><p>Let <var title>pointer</var> be the <span>index pointer</span> for
 <var title>code point</var> in <span>index euc-kr</span>.

 <li><p>If <var title>pointer</var> is null, emit an
 <span>encoder error</span>.

 <li>
  <p>If <var title>pointer</var> is less than
  (26 + 26 + 126) &times; (0xC7 &minus; 0x81), run these substeps:

  <ol>
   <li><p>Let <var title>lead</var> be
   <var title>pointer</var> / (26 + 26 + 126) + 1.

   <li><p>Let <var title>trail</var> be
   <var title>pointer</var> % (26 + 26 + 126) &minus; 26 &minus; 26 + 1.

   <li><p>If <var title>lead</var> is not in the range 0x21 to 0x46 or
   <var title>trail</var> is not in the range 0x21 to 0x7E, emit an
   <span>encoder error</span>.

   <li><p>Emit two bytes whose values are <var title>lead</var> and
   <var title>trail</var>.
  </ol>

 <li><p>Set <var title>pointer</var> to
 <var title>pointer</var> &minus; (26 + 26 + 126) × (0xC7 − 0x81).

 <li><p>Let <var title>lead</var> be <var title>pointer</var> / 94 + 0x47.

 <li><p>Let <var title>trail</var> be <var title>pointer</var> % 94 + 0x21.

 <li><p>If <var title>lead</var> is not in the range 0x47 to 0x7E or
 <var title>trail</var> is not in the range 0x21 to 0x7E, emit an
 <span>encoder error</span>.

 <li><p>Emit two bytes whose values are <var title>lead</var> and
 <var title>trail</var>.
</ol>


<h2>Legacy utf-16 encodings</h2>

<p class=note>Contrary to the Unicode standard, checking for a
byte order mark happens before an encoding to decode a byte stream is
chosen.


<h3><dfn>utf-16</dfn></h3>

<p>The <dfn>utf-16 lead byte</dfn> and <dfn>utf-16 lead surrogate</dfn>
are initially null and the <dfn>utf-16be flag</dfn> is initially unset.

<p>The <dfn>utf-16 decoder</dfn> (<span>decoder</span> for <span>utf-16</span>) is:

<ol>
 <li><p>Let <var title>byte</var> be <span>byte pointer</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and
 <span>utf-16 lead byte</span> and <span>utf-16 lead surrogate</span> are
 null, emit the <span>EOF code point</span>.

 <li><p>If <var title>byte</var> is the <span>EOF byte</span> and either
 <span>utf-16 lead byte</span> or <span>utf-16 lead surrogate</span> is not
 null, set <span>utf-16 lead byte</span> and
 <span>utf-16 lead surrogate</span> to null, and emit a
 <span>decoder error</span>.

 <li><p>Increase the <span>byte pointer</span> by one.

 <li><p>If <span>utf-16 lead byte</span> is null, set
 <span>utf-16 lead byte</span> to <var title>byte</var> and continue.

 <li>
  <p>Let <var title>code point</var> be the result of:

  <dl class=switch>
   <dt><span>utf-16be flag</span> is set
   <dd><p>(<span>utf-16 lead byte</span> &lt;&lt; 8) + <var title>byte</var>.
   <dt><span>utf-16be flag</span> is unset
   <dd><p>(<var title>byte</var> &lt;&lt; 8) + <span>utf-16 lead byte</span>.
  </dl>

  <p>Then set <span>utf-16 lead byte</span> to null.

 <li>
  <p>If <span>utf-16 lead surrogate</span> is not null, let
  <var title>lead surrogate</var> be <span>utf-16 lead surrogate</span>, set
  <span>utf-16 lead surrogate</span> to null, and then run these substeps:

  <ol>
   <li><p>If <var title>code point</var> is in the range U+DC00 to U+DFFF,
   emit a code point whose value is
   0x10000 + (<var title>lead surrogate</var> &minus; 0xD800) &times; 0x400 + (<var title>code point</var> &minus; 0xDC00).

   <li><p>Decrease the <span>byte pointer</span> by two and emit a
   <span>decoder error</span>.
   <!-- unpaired surrogates; IE/WebKit output them, Gecko/Opera FFFD them -->
  </ol>

 <li><p>If <var title>code point</var> is in the range U+D800 to U+DBFF, set
 <span>utf-16 lead surrogate</span> to <var title>code point</var> and
 continue.

 <li><p>If <var title>code point</var> is in the range U+DC00 to U+DFFF,
 emit a <span>decoder error</span>.
 <!-- unpaired surrogates; IE/WebKit output them, Gecko/Opera FFFD them -->

 <li><p>Emit code point <var title>code point</var>.
</ol>

<p>To <dfn>convert a <var title>code unit</var> to bytes</dfn> run these steps:

<ol>
 <li><p>Let <var title>byte1</var> be <var title>code unit</var> >> 8.

 <li><p>Let <var title>byte2</var> be
 <var title>code unit</var> &amp; 0x00FF.

 <li>
  <p>Then return the bytes in order:

  <dl class=switch>
   <dt><span>utf-16be flag</span> is set
   <dd><p><var title>byte1</var>, then <var title>byte2</var>.
   <dt><span>utf-16be flag</span> is unset
   <dd><p><var title>byte2</var>, then <var title>byte1</var>.
  </dl>
</ol>

<p>The <dfn>utf-16 encoder</dfn> (<span>encoder</span> for <span>utf-16</span>) is:

<ol>
 <li><p>Let <var title>code point</var> be <span>code point pointer</span>.

 <li><p>If <var title>code point</var> is in the range 0xD800 to 0xDFFF,
 emit an <span>encoder error</span>.

 <li><p>If <var title>code point</var> is the <span>EOF code point</span>,
 emit the <span>EOF byte</span>.

 <li><p>Increase the <span>code point pointer</span> by one.

 <li><p>If <var title>code point</var> is in the range 0x00 to 0xFFFF, emit
 the sequence resulting of
 <span title="convert a code unit to bytes">converting <var title>code point</var> to bytes</span>.

 <li><p>Let <var title>lead</var> be
 (<var title>code point</var> &minus; 0x10000) / 0x400 + 0xD800,
 <span title="convert a code unit to bytes">converted to bytes</span>.

 <li><p>Let <var title>trail</var> be
 (<var title>code point</var> &minus; 0x10000) % 0x400 + 0xDC00,
 <span title="convert a code unit to bytes">converted to bytes</span>.

 <li><p>Emit a sequence of bytes that consists of <var title>lead</var>
 followed by <var title>trail</var>.
</ol>


<h3><dfn>utf-16be</dfn></h3>

<p>The <dfn>utf-16be decoder</dfn> (<span>decoder</span> for <span>utf-16be</span>)
is the <span>utf-16 decoder</span> with the <span>utf-16be flag</span> set.

<p>The <dfn>utf-16be encoder</dfn> (<span>encoder</span> for <span>utf-16be</span>)
is the <span>utf-16 encoder</span> with the <span>utf-16be flag</span> set.


<h2 class=no-num>References</h2>

<div id=anolis-references></div>


<h2 class=no-num>Acknowledgments</h2>

<p>There have been a lot of people that have helped make encodings more
interoperable over the years and thereby furthered the goals of this
specification. Likewise people have helped making this specification what it
is today.

<p>Ideally they are all listed here so please contact the editor with any
omissions.

<p>With that, many thanks to

Charles McCathieNeville,
David Carlisle,
Doug Ewell,
Erik van der Poel,
譚永鋒 (Frank Yung-Fong Tang),
Ian Hickson,
James Graham,
Joshua Bell,
신정식 (Jungshik Shin),
Ken Lunde,
Leif Halvard Silli,
Makoto Kato,
Mark Callow,
Mark Davis,
Martin Dürst,
Masatoshi Kimura,
Ms2ger,
Norbert Lindenberg,
Øistein E. Andersen,
Peter Krefting,
Philip Jägenstedt,
Philip Taylor,
Shawn Steele,
Simon Montagu,
Simon Pieters, and
成瀬ゆい (Yui Naruse)

for being awesome.


<script id=head src=http://www.whatwg.org/specs/web-apps/current-work/dfn.js></script>
